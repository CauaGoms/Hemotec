{% extends "doador/doador__base.html" %}
{% block custom_css %}
<link href="/static/css/doador/doador_inicio.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css">
{% endblock %}

{% block conteudo %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title mt-5">Bem-vindo ao Hemotec {{usuario.nome}}</h1>
            <p class="hero-subtitle">Gerencie doações, acompanhe campanhas e salve vidas com nossa plataforma integrada</p>
            <div class="d-flex flex-wrap justify-content-center">
                <a href="/doador/agendamento/adicionar">
                    <button class="btn btn-schedule" onclick="agendarDoacao()">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Agendar Doação
                    </button>
                </a>
                <a href="/doador/campanha">
                    <button class="btn btn-secondary-hero" onclick="verCampanhas()">
                        <i class="fas fa-bullhorn me-2"></i>
                        Ver Campanhas
                    </button>
                </a>
            </div>
        </div>
    </div>
</section>
<main class="container">
    <!-- Quick Actions -->
    <section class="quick-actions">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="mb-3">
                    <i class="fas fa-bolt me-2"></i>
                    Ações Rápidas
                </h4>
                <p class="mb-0">Acesse rapidamente as principais funcionalidades do sistema</p>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn" onclick="window.location.href='/doador/doacoes'">
                    <i class="fas fa-hand-holding-heart me-2"></i>
                    Doações
                </button>
                <button class="btn" onclick="window.location.href='/doador/notificacao'">
                    <i class="fas fa-bell me-2"></i>
                    Notificações
                </button>
                <button class="btn" onclick="window.location.href='/doador/carteira'">
                    <i class="fas fa-id-card me-2"></i>
                    Carteira do Doador
                </button>
            </div>
        </div>
    </section>
    <!-- Seção de Estoque -->
    <section class="my-5">
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card p-4">
                    <div class="text-center mb-4">
                        <h3 class="section-title">
                            Estoque de Sangue
                            <span id="nome-unidade-estoque" class="text-muted" style="font-size: 0.85em;"></span>
                        </h3>
                        <p class="text-muted small">Selecione uma unidade para visualizar o estoque</p>
                    </div>
                    <!-- Visualização do Estoque -->
                    <div id="estoque-atual" class="blood-stock-modern mb-4"></div>
                    <!-- Botões de Unidades -->
                    <div class="unidade-selector">
                        <ul id="lista-unidades-estoque" class="unidade-buttons-grid"></ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="my-5">
        <div class="row">
            <!-- Seção de Informações Importantes Modernizada -->
            <div class="col-md-12 mb-4">
                <div class="card border-0 shadow-lg" style="border-radius: 20px; background: #fff;">
                    <div class="card-body p-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="card-title text-danger mb-0 fw-bold" style="font-size: 1.8rem;">
                                <i class="fas fa-info-circle me-3" style="color: #e02020;"></i>
                                Informações Importantes
                            </h3>
                            <div class="info-badge">
                                <span class="badge" style="background: linear-gradient(90deg, #e02020 0%, #ff4040 100%); font-size: 0.9rem; padding: 8px 16px; border-radius: 20px;">Leia com atenção</span>
                            </div>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="info-card h-100" style="background: #fff; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(224,32,32,0.08); border-left: 4px solid #e02020; transition: transform 0.3s ease;">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-wrapper" style="background: linear-gradient(135deg, #e02020 0%, #ff4040 100%); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                            <i class="fas fa-clock text-white" style="font-size: 1.3rem;"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold" style="color: #2c3e50;">Atenção ao Sono</h5>
                                    </div>
                                    <p class="text-muted mb-0" style="font-size: 1.05rem; line-height: 1.6;">
                                        Durma pelo menos
                                        <strong>6 horas</strong>
                                        na noite anterior à doação para garantir seu bem-estar.
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-card h-100" style="background: #fff; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(224,32,32,0.08); border-left: 4px solid #e02020; transition: transform 0.3s ease;">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-wrapper" style="background: linear-gradient(135deg, #e02020 0%, #ff4040 100%); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                            <i class="fas fa-user-check text-white" style="font-size: 1.3rem;"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold" style="color: #2c3e50;">Requisitos Básicos</h5>
                                    </div>
                                    <p class="text-muted mb-0" style="font-size: 1.05rem; line-height: 1.6;">
                                        <strong>Idade:</strong>
                                        16 a 69 anos
                                        <br>
                                        <strong>Peso mínimo:</strong>
                                        50kg
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-card h-100" style="background: #fff; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(224,32,32,0.08); border-left: 4px solid #e02020; transition: transform 0.3s ease;">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-wrapper" style="background: linear-gradient(135deg, #e02020 0%, #ff4040 100%); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                            <i class="fas fa-calendar-alt text-white" style="font-size: 1.3rem;"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold" style="color: #2c3e50;">Intervalo entre Doações</h5>
                                    </div>
                                    <p class="text-muted mb-0" style="font-size: 1.05rem; line-height: 1.6;">
                                        <strong>Homens:</strong>
                                        60 dias
                                        <br>
                                        <strong>Mulheres:</strong>
                                        90 dias
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-card h-100" style="background: #fff; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(224,32,32,0.08); border-left: 4px solid #e02020; transition: transform 0.3s ease;">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-wrapper" style="background: linear-gradient(135deg, #e02020 0%, #ff4040 100%); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                            <i class="fas fa-id-card text-white" style="font-size: 1.3rem;"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold" style="color: #2c3e50;">Documentos Necessários</h5>
                                    </div>
                                    <p class="text-muted mb-0" style="font-size: 1.05rem; line-height: 1.6;">
                                        <strong>RG, CPF ou CNH</strong>
                                        <br>
                                        Em boas condições
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Adicionar uma dica importante no final -->
                        <div class="alert alert-info mt-4" style="background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%); border: none; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-lightbulb text-info me-3" style="font-size: 1.4rem;"></i>
                                <div>
                                    <h6 class="mb-1 fw-bold text-info">Dica Importante</h6>
                                    <p class="mb-0 text-muted">Alimente-se bem antes da doação e evite bebidas alcoólicas nas 12 horas anteriores.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="quote-section">
        <p class="quote-text">Doar sangue não é só um ato de solidariedade, é um compromisso com a vida. Cada gota doada é uma chance de recomeço para alguém.</p>
        <p class="quote-author">— Campanha Nacional de Doação de Sangue</p>
    </section>
    <!-- Seção de Notificações e Campanhas -->
    <section class="my-5">
        <div class="row">
            <!-- Seção de Notificações -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-lg" style="border-radius: 20px; background: #fff;">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="section-title mb-0 fw-bold" style="color: #2c3e50; font-size: 1.4rem;">
                                <i class="fas fa-bell me-3" style="color: #e02020;"></i>
                                Notificações Recentes
                            </h5>
                            <div class="notification-badge">
                                <span class="badge bg-danger" style="border-radius: 20px; padding: 6px 12px;">{{ total_nao_lidas }} nova{% if total_nao_lidas != 1 %}s{% endif %}</span>
                            </div>
                        </div>
                        <div class="notifications-container">
                            {% if notificacoes_recentes %}
                                {% for notif in notificacoes_recentes %}
                                    {% set tipo_lower = notif.tipo.lower() %}
                                    {% if tipo_lower == 'estoque' %}
                                        {% set cor_borda = '#e02020' %}
                                        {% set cor_fundo = 'linear-gradient(135deg, #fff5f5 0%, #fff 100%)' %}
                                        {% set cor_icone_bg = '#fee2e2' %}
                                        {% set icone = 'exclamation-triangle' %}
                                        {% set cor_icone = 'text-danger' %}
                                    {% elif tipo_lower == 'campanha' %}
                                        {% set cor_borda = '#22c55e' %}
                                        {% set cor_fundo = 'linear-gradient(135deg, #f0fdf4 0%, #fff 100%)' %}
                                        {% set cor_icone_bg = '#dcfce7' %}
                                        {% set icone = 'bullhorn' %}
                                        {% set cor_icone = 'text-success' %}
                                    {% elif tipo_lower == 'agendamento' %}
                                        {% set cor_borda = '#3b82f6' %}
                                        {% set cor_fundo = 'linear-gradient(135deg, #eff6ff 0%, #fff 100%)' %}
                                        {% set cor_icone_bg = '#dbeafe' %}
                                        {% set icone = 'calendar-alt' %}
                                        {% set cor_icone = 'text-info' %}
                                    {% else %}
                                        {% set cor_borda = '#6b7280' %}
                                        {% set cor_fundo = 'linear-gradient(135deg, #f9fafb 0%, #fff 100%)' %}
                                        {% set cor_icone_bg = '#e5e7eb' %}
                                        {% set icone = 'bell' %}
                                        {% set cor_icone = 'text-secondary' %}
                                    {% endif %}
                            <div class="notification-item modern-notification" style="background: {{ cor_fundo }}; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 4px solid {{ cor_borda }}; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s ease; cursor: pointer;" onclick="window.location.href='/doador/notificacao'">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="notification-icon" style="background: {{ cor_icone_bg }}; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                                <i class="fas fa-{{ icone }} {{ cor_icone }}"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 fw-bold" style="color: #2c3e50;">{{ notif.titulo }}</h6>
                                                <small class="text-muted" id="data-notif-{{ loop.index }}"></small>
                                            </div>
                                        </div>
                                        <p class="mb-0 text-muted" style="font-size: 0.95rem; line-height: 1.5; margin-left: 52px;">
                                            {{ notif.mensagem }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <script>
                                        // Formatar data para "Há X horas/dias"
                                        (function() {
                                            const dataStr = "{{ notif.data_envio }}";
                                            const data = new Date(dataStr);
                                            const agora = new Date();
                                            const diffMs = agora - data;
                                            const diffHoras = Math.floor(diffMs / (1000 * 60 * 60));
                                            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                                            
                                            let textoData;
                                            if (diffHoras < 1) {
                                                textoData = 'Agora mesmo';
                                            } else if (diffHoras < 24) {
                                                textoData = `Há ${diffHoras} hora${diffHoras > 1 ? 's' : ''}`;
                                            } else if (diffDias === 1) {
                                                textoData = 'Ontem';
                                            } else if (diffDias < 7) {
                                                textoData = `Há ${diffDias} dias`;
                                            } else {
                                                textoData = data.toLocaleDateString('pt-BR');
                                            }
                                            
                                            document.getElementById('data-notif-{{ loop.index }}').textContent = textoData;
                                        })();
                            </script>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Nenhuma notificação no momento</p>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Botão para ver todas as notificações -->
                        <div class="text-center mt-3">
                            <a href="/doador/notificacao" class="btn btn-outline-primary" style="border-radius: 25px; padding: 8px 20px; font-size: 0.9rem; text-decoration: none;">
                                <i class="fas fa-eye me-2"></i>
                                Ver todas as notificações
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Seção de Campanhas Ativas -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-lg" style="border-radius: 20px; background: #fff;">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="section-title mb-0 fw-bold" style="color: #2c3e50; font-size: 1.4rem;">
                                <i class="fas fa-bullhorn me-3" style="color: #e02020;"></i>
                                Campanhas Ativas
                            </h5>
                            <div class="campaign-badge">
                                <span class="badge bg-success" style="border-radius: 20px; padding: 6px 12px;">{{ total_campanhas_ativas }} ativa{% if total_campanhas_ativas != 1 %}s{% endif %}</span>
                            </div>
                        </div>
                        <div class="campaigns-container">
                            {% if campanhas_ativas %}
                                {% for campanha in campanhas_ativas %}
                                    {% set cores = [
                                        {'borda': '#e02020', 'fundo': 'linear-gradient(135deg, #fef2f2 0%, #fff 100%)', 'icone_bg': 'linear-gradient(135deg, #e02020 0%, #ff4040 100%)', 'icone': 'tint'},
                                        {'borda': '#f59e0b', 'fundo': 'linear-gradient(135deg, #fffbeb 0%, #fff 100%)', 'icone_bg': 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)', 'icone': 'heart'},
                                        {'borda': '#22c55e', 'fundo': 'linear-gradient(135deg, #f0fdf4 0%, #fff 100%)', 'icone_bg': 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', 'icone': 'users'}
                                    ] %}
                                    {% set cor = cores[loop.index0 % 3] %}
                                    {% set margin_bottom = '20px' if not loop.last else '0' %}
                            <div class="campaign-item" style="background: {{ cor.fundo }}; border-radius: 15px; padding: 20px; margin-bottom: {{ margin_bottom }}; border-left: 4px solid {{ cor.borda }}; box-shadow: 0 4px 15px rgba(224,32,32,0.08); transition: transform 0.3s ease; cursor: pointer;" onclick="window.location.href='/doador/campanha/{{ campanha.cod_campanha }}'">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="campaign-icon" style="background: {{ cor.icone_bg }}; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <i class="fas fa-{{ cor.icone }} text-white" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold" style="color: #2c3e50;">{{ campanha.titulo }}</h6>
                                        <p class="mb-2 text-muted" style="font-size: 0.9rem;">{{ campanha.descricao[:50] }}{% if campanha.descricao|length > 50 %}...{% endif %}</p>
                                        <div class="progress" style="height: 8px; border-radius: 10px; background: #f3f4f6;">
                                            {% set dias_total = (campanha.data_fim - campanha.data_inicio).days %}
                                            {% set dias_passados = (now().date() - campanha.data_inicio).days %}
                                            {% set progresso = (dias_passados / dias_total * 100) if dias_total > 0 else 0 %}
                                            <div
                                                class="progress-bar bg-success"
                                                style="width: {{ progresso|round|int }}%; border-radius: 10px;"
                                                role="progressbar"
                                                aria-valuenow="{{ progresso|round|int }}"
                                                aria-valuemin="0"
                                                aria-valuemax="100"
                                            ></div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">{{ progresso|round|int }}% do período</small>
                                            <span class="badge bg-success" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 10px;">Ativa</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Nenhuma campanha ativa no momento</p>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Botão para gerenciar campanhas -->
                        <div class="text-center mt-3">
                            <a href="/doador/campanha" class="btn btn-outline-danger" style="border-radius: 25px; padding: 8px 20px; font-size: 0.9rem; text-decoration: none;">
                                <i class="fas fa-eye me-2"></i>
                                Ver todas as campanhas
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<!-- Mapa Section (atualizado) -->
<section class="container mb-5">
    <div class="text-center mb-4">
        <h2 class="section-title">Unidades de Coleta</h2>
    </div>
    <div class="map-tools">
        <button id="btn-locate" type="button">Minha Localização</button>
        <button id="btn-clear-route" type="button" disabled>Limpar Rota</button>
        <span class="geo-status" id="geo-status"></span>
    </div>
    <div id="info-rota" class="info-box"></div>
    <div id="mapa"></div>
    <ul id="lista-unidades" class="unidade-list"></ul>
</section>
{% endblock %}
<!-- Custom JavaScript -->
{% block custom_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="/static/js/doador/doador_inicio.js"></script>
<!-- Modal de Compatibilidade -->
<div
    class="modal fade"
    id="compatModal"
    tabindex="-1"
    aria-labelledby="compatModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered" style="max-width: 370px; height: 200px;">
        <div class="modal-content" style="border-radius: 22px; box-shadow: 0 8px 32px rgba(224,32,32,0.15); border: none;">
            <div class="modal-header" style="background: linear-gradient(90deg, #e02020 0%, #ff4040 100%); border-radius: 22px 22px 0 0;">
                <h5 class="modal-title text-white fw-bold" id="compatModalLabel">Compatibilidade Sanguínea</h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Fechar"
                ></button>
            </div>
            <div class="modal-body" id="compatModalBody" style="font-size: 1.1rem; color: #333; padding: 2rem 1.5rem; background: #fff; border-radius: 0 0 22px 22px;">
                <!-- Conteúdo JS --></div>
            <div class="modal-footer" style="background: #fff; border-radius: 0 0 22px 22px; border-top: none;">
                <button
                    type="button"
                    class="btn btn-danger"
                    style="border-radius: 50px; padding: 0.6rem 2.2rem; font-weight: 600; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(224,32,32,0.08);"
                    data-bs-dismiss="modal"
                >Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
