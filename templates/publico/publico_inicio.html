{% extends "publico/publico__base.html" %}

{% block custom_css %}
<link href="/static/css/publico/publico_inicio.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css">
{% endblock %}

{% block corpo %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Bem-vindo ao Sistema Hemotec</h1>
            <p class="hero-subtitle">Transformando doações em esperança, conectando vidas através do sangue</p>
            <a href="/login">
                <button class="btn btn-primary btn-login">Fazer Login</button>
            </a>
            <a href="/adquirir_assinatura">
                <button class="btn btn-primary btn-assinatura">Adquirir Assinatura</button>
            </a>
        </div>
    </div>
</section>
<section class="container">
    <div class="text-center mb-5">
        <h2 class="section-title">Campanhas Recentes</h2>
    </div>
    <div class="row">
        <!-- ...existing code (cards) ... -->
        <div class="col-md-4">
            <div class="card">
                <img src="/static/img/imagem_doacao.avif" class="card-img-top" alt="Campanha de Doação">
                <div class="card-body">
                    <h5 class="card-title">Junho Vermelho</h5>
                    <p class="card-text">Participe da nossa campanha de conscientização sobre a importância da doação de sangue. Cada doação pode salvar até 4 vidas!</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Publicado em 01/06/2025</small>
                    <a href="/campanha" class="btn btn-outline-danger float-end">Saiba mais</a>
                </div>
            </div>
        </div>
        <!-- ...existing code (restante dos cards) ... -->
        <div class="col-md-4">
            <div class="card">
                <img src="/static/img/imagem_laboratorio.avif" class="card-img-top" alt="Doação Coletiva">
                <div class="card-body">
                    <h5 class="card-title">Doação Coletiva Empresarial</h5>
                    <p class="card-text">Empresas parceiras estão organizando doações coletivas. Veja como sua empresa pode participar desta iniciativa solidária.</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Publicado em 15/05/2025</small>
                    <a href="/campanha" class="btn btn-outline-danger float-end">Saiba mais</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <img src="/static/img/imagem_imunoglobulina.avif" class="card-img-top" alt="Aplicativo Hemotec">
                <div class="card-body">
                    <h5 class="card-title">Novo Aplicativo Hemotec</h5>
                    <p class="card-text">Lançamos nosso aplicativo para facilitar o agendamento de doações e acompanhamento do histórico de doações. Baixe agora!</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Publicado em 10/05/2025</small>
                    <a href="/campanha" class="btn btn-outline-danger float-end">Saiba mais</a>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="quote-section">
    <div class="container text-center">
        <p class="quote-text">Doar sangue não é só um ato de solidariedade, é um compromisso com a vida. Cada gota doada é uma chance de recomeço para alguém.</p>
        <p class="quote-author">— Campanha Nacional de Doação de Sangue</p>
    </div>
</section>
<section class="container my-5">
    <!-- ...existing code (informações + estoque) ... -->
    <div class="row">
        <!-- Blocos mantidos sem alteração estrutural -->
        <div class="col-lg-12 mb-4">
            <!-- Informações Importantes (original) -->
            <!-- ...existing code... -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h3 class="card-title text-danger mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações Importantes
                    </h3>
                    <div class="row">
                        <!-- ...existing info items... -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-clock text-danger me-3 mt-1"></i>
                                <div>
                                    <h6 class="mb-1">Atenção</h6>
                                    <p class="text-muted mb-0">
                                        Durma pelo menos 6 horas
                                        <br>
                                        na noite anterior à doação.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-user-check text-danger me-3 mt-1"></i>
                                <div>
                                    <h6 class="mb-1">Requisitos Básicos</h6>
                                    <p class="text-muted mb-0">
                                        Idade: 16 a 69 anos
                                        <br>
                                        Peso mínimo: 50kg
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-calendar-alt text-danger me-3 mt-1"></i>
                                <div>
                                    <h6 class="mb-1">Intervalo entre Doações</h6>
                                    <p class="text-muted mb-0">
                                        Homens: 60 dias
                                        <br>
                                        Mulheres: 90 dias
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-id-card text-danger me-3 mt-1"></i>
                                <div>
                                    <h6 class="mb-1">Documentos Necessários</h6>
                                    <p class="text-muted mb-0">
                                        RG, CPF ou CNH
                                        <br>
                                        Em boas condições
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Estoque Atual (original) -->
        <div class="col-lg-12 mb-4">
            <!-- ...existing code (estoque) ... -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4 d-flex flex-column">
                    <h4 class="card-title text-danger mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Estoque Atual -
                        <span id="nome-unidade-estoque">Carregando...</span>
                    </h4>
                    <!-- ...existing code (progress bars) ... -->
                    <div class="row">
                        <!-- ...existing progress bars left/right ... -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">O+</span>
                                    <span class="badge bg-danger">Crítico</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-danger" style="width:20%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">A+</span>
                                    <span class="badge bg-warning">Baixo</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-warning" style="width:35%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">B+</span>
                                    <span class="badge bg-success">Adequado</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-success" style="width:70%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">AB+</span>
                                    <span class="badge bg-warning">Baixo</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-warning" style="width:30%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">O-</span>
                                    <span class="badge bg-warning">Moderado</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-warning" style="width:45%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">A-</span>
                                    <span class="badge bg-success">Adequado</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-success" style="width:65%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">B-</span>
                                    <span class="badge bg-danger">Crítico</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-danger" style="width:25%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">AB-</span>
                                    <span class="badge bg-success">Adequado</span>
                                </div>
                                <div class="progress mb-2" style="height:8px;">
                                    <div class="progress-bar bg-success" style="width:80%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <div class="alert alert-danger mb-0" role="alert">
                            <small>
                                <i class="fas fa-heart me-1"></i>
                                Sua doação pode salvar vidas! Tipos O+, A+ e B- são urgentes.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Mapa Section (atualizado) -->
<section class="container mb-5">
    <div class="text-center mb-4">
        <h2 class="section-title">Unidades de Coleta</h2>
    </div>
    <div class="map-tools">
        <button id="btn-locate" type="button">Minha Localização</button>
        <button id="btn-clear-route" type="button" disabled>Limpar Rota</button>
        <span class="geo-status" id="geo-status"></span>
    </div>
    <div id="mapa"></div>
    <div id="info-rota" class="info-box"></div>
    <ul id="lista-unidades" class="unidade-list"></ul>
</section>
{% endblock %}

{% block custom_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
(function(){
    // Config das unidades será carregado dinamicamente do backend
    fetch('/api/unidades')
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao carregar dados da API: ' + response.statusText);
            }
            return response.json();
        })
        .then(unidades => {
            if (!Array.isArray(unidades) || unidades.length === 0) {
                console.error('Nenhuma unidade encontrada ou formato inválido.');
                return;
            }

            const mapa = L.map('mapa', { zoomControl:true, attributionControl:true })
                .setView([-20.851136957150032, -41.113483188824155], 11); // Coordenadas iniciais

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(mapa);

            const statusEl = document.getElementById('geo-status');
            const infoRota = document.getElementById('info-rota');
            const btnLocate = document.getElementById('btn-locate');
            const btnClear = document.getElementById('btn-clear-route');
            const listaUnidades = document.getElementById('lista-unidades');

            let userMarker = null;
            let routingControl = null;

            function listarUnidades(){
                listaUnidades.innerHTML = '';
                unidades.forEach(u => {
                    const [nome, coords] = Object.entries(u)[0];
                    const [lat, lng] = coords;

                    const li = document.createElement('li');
                    li.innerHTML = '<strong>' + nome + '</strong><span>Coordenadas: ' + lat + ', ' + lng + '</span>';
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = 'Rota';
                    btn.classList.add('btn-rota');
                    btn.addEventListener('click', () => {
                        if (!userMarker) {
                            statusEl.textContent = 'Obtenha sua localização primeiro.';
                            return;
                        }
                        criarRota([userMarker.getLatLng().lat, userMarker.getLatLng().lng], [lat, lng], nome);
                    });
                    li.appendChild(btn);
                    listaUnidades.appendChild(li);
                });
            }

            const unidadeIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                shadowSize: [41, 41]
            });

            unidades.forEach(u => {
                const [nome, coords] = Object.entries(u)[0];
                const [lat, lng] = coords;

                const m = L.marker([lat, lng], { icon: unidadeIcon }).addTo(mapa);
                m.bindPopup('<strong>' + nome + '</strong><br>Coordenadas: ' + lat + ', ' + lng + '<br><button type="button" class="btn-rota" data-id="' + nome + '">Traçar rota</button>');
                m.on('popupopen', (e) => {
                    const btn = e.popup._contentNode.querySelector('.btn-rota');
                    btn.addEventListener('click', () => {
                        if (!userMarker) {
                            statusEl.textContent = 'Obtenha sua localização primeiro.';
                            return;
                        }
                        criarRota([userMarker.getLatLng().lat, userMarker.getLatLng().lng], [lat, lng], nome);
                        mapa.closePopup();
                    });
                });
            });

            function obterLocalizacao() {
                if (!('geolocation' in navigator)) {
                    statusEl.textContent = 'Geolocalização não suportada.';
                    return;
                }
                statusEl.textContent = 'Obtendo localização...';
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    statusEl.textContent = 'Localização obtida.';
                    if (userMarker) {
                        userMarker.setLatLng([latitude, longitude]);
                    } else {
                        userMarker = L.marker([latitude, longitude], {
                            icon: L.icon({
                                iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/man.png',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32]
                            })
                        }).addTo(mapa).bindPopup('Você está aqui.').openPopup();
                    }
                    mapa.flyTo([latitude, longitude], 13, { duration: 0.8 });
                }, err => {
                    statusEl.textContent = 'Erro: ' + err.message;
                }, { enableHighAccuracy: true, timeout: 10000 });
            }

            function criarRota(origem, destino, nome) {
                if (routingControl) {
                    mapa.removeControl(routingControl);
                    routingControl = null;
                }
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(origem[0], origem[1]),
                        L.latLng(destino[0], destino[1])
                    ],
                    lineOptions: {
                        styles: [{ color: '#dc3545', weight: 5, opacity: 0.85 }]
                    },
                    show: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    routeWhileDragging: false,
                    language: 'pt-BR'
                }).addTo(mapa);

                routingControl.on('routesfound', e => {
                    const r = e.routes[0];
                    const distKm = (r.summary.totalDistance / 1000).toFixed(2);
                    const durMin = Math.round(r.summary.totalTime / 60);
                    infoRota.innerHTML = '<strong>Rota até ' + nome + '</strong><br>Distância: ' + distKm + ' km<br>Tempo estimado: ' + durMin + ' min';
                    btnClear.disabled = false;
                });

                routingControl.on('routingerror', () => {
                    infoRota.innerHTML = 'Falha ao calcular rota.';
                    btnClear.disabled = false;
                });
            }

            btnLocate.addEventListener('click', obterLocalizacao);
            btnClear.addEventListener('click', () => {
                if (routingControl) {
                    mapa.removeControl(routingControl);
                    routingControl = null;
                }
                infoRota.innerHTML = '';
                btnClear.disabled = true;
            });

            listarUnidades();

            // Auto tentar localização se seguro (localhost ou https)
            if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                setTimeout(() => obterLocalizacao(), 600);
            } else {
                statusEl.textContent = 'Ative HTTPS ou use localhost para geolocalização automática.';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar unidades:', error);
        });
})();
</script>
<!-- (Opcional) remover script externo antigo se estava vazio ou falhando -->
<!-- <script src="/static/js/publico/publico_inicio.js"></script> -->
{% endblock %}
